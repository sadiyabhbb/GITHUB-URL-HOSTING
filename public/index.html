<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ü§ñ Bot Hosting Panel</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #0b0b0b;
      color: #eaeaea;
      padding: 16px;
      margin: 0;
    }

    h1, h2, h3 {
      text-align: center;
    }

    input, button {
      padding: 10px;
      margin: 6px 0;
      border-radius: 6px;
      border: none;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      font-size: 15px;
    }

    input {
      background: #1a1a1a;
      color: #eee;
    }

    button {
      background: #2a2a2a;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #444;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .panel {
      background: #111;
      padding: 14px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
      margin-bottom: 16px;
    }

    .row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    @media (min-width: 700px) {
      .row {
        flex-direction: row;
        gap: 10px;
        align-items: center;
      }
      input {
        width: auto;
        flex: 1;
      }
      #entry {
        width: 180px;
      }
      button {
        width: auto;
      }
    }

    pre {
      background: #000;
      color: #0f0;
      padding: 12px;
      height: 320px;
      overflow-y: auto;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bots {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .bot {
      background: #1a1a1a;
      padding: 10px;
      border-radius: 8px;
    }

    .status {
      font-size: 13px;
      margin-bottom: 4px;
    }

    .status.running { color: #00ff66; }
    .status.stopped { color: #ff5555; }
    .status.installing { color: #ffaa00; }
    .status.cloning { color: #66aaff; }

    small { color: #aaa; font-size: 13px; }

    #clear {
      width: 100%;
      margin-top: 10px;
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <h2>ü§ñ Bot Hosting Panel</h2>

    <div class="panel">
      <div class="row">
        <input id="repo" placeholder="Git repo URL (e.g. https://github.com/user/repo.git)">
        <input id="name" placeholder="optional name">
        <input id="entry" placeholder="entry file (default index.js)">
        <button id="deploy">üöÄ Deploy</button>
      </div>
      <small>After deploy, the repo will be cloned & dependencies installed automatically.</small>
    </div>

    <h3>Deployed Bots</h3>
    <div id="bots" class="bots"></div>

    <h3>üìú Live Logs</h3>
    <div class="panel">
      <pre id="logs">No logs yet. Select a bot and click ‚ÄúAttach‚Äù.</pre>
      <button id="clear">üßπ Clear Logs</button>
    </div>
  </div>

  <script>
  const socket = io();
  let currentId = null;

  async function refreshBots() {
    const res = await fetch('/api/bots');
    const list = await res.json();
    const container = document.getElementById('bots');
    container.innerHTML = '';

    list.forEach(b => {
      const el = document.createElement('div');
      el.className = 'bot';
      el.innerHTML = `
        <strong>${b.name}</strong>
        <div class="status ${b.status}">Status: ${b.status}</div>
        <div>
          <button onclick="start('${b.id}')">Start</button>
          <button onclick="stop('${b.id}')">Stop</button>
          <button onclick="restart('${b.id}')">Restart</button>
          <button onclick="attach('${b.id}')">Attach</button>
        </div>`;
      container.appendChild(el);
    });
  }

  async function deploy() {
    const repo = document.getElementById('repo').value.trim();
    const name = document.getElementById('name').value.trim();
    const entry = document.getElementById('entry').value.trim() || 'index.js';
    if (!repo) return alert('Please enter a repository URL.');

    const btn = document.getElementById('deploy');
    btn.disabled = true;
    btn.textContent = '‚öôÔ∏è Deploying...';

    try {
      const res = await fetch('/api/deploy', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ repoUrl: repo, name, entry })
      });
      const j = await res.json();
      if (j.error) alert('‚ùå Error: ' + j.error);
      else {
        alert('‚úÖ Deployed: ' + j.name);
        refreshBots();
      }
    } catch (err) {
      alert('Deploy failed: ' + err.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'üöÄ Deploy';
    }
  }

  async function start(id) { await fetch(`/api/${id}/start`, { method: 'POST' }); refreshBots(); }
  async function stop(id) { await fetch(`/api/${id}/stop`, { method: 'POST' }); refreshBots(); }
  async function restart(id) { await fetch(`/api/${id}/restart`, { method: 'POST' }); refreshBots(); }

  async function attach(id) {
    currentId = id;
    const pre = document.getElementById('logs');
    pre.textContent = 'üì° Attached. Waiting for logs...';
    socket.emit('subscribe', id);

    const r = await fetch(`/api/${id}/logs`);
    const j = await r.json();
    if (j.logs) pre.textContent = j.logs.join('');
    pre.scrollTop = pre.scrollHeight;
  }

  document.getElementById('deploy').onclick = deploy;
  document.getElementById('clear').onclick = () => document.getElementById('logs').textContent = '';

  socket.on('log', chunk => {
    const pre = document.getElementById('logs');
    pre.textContent += chunk;
    pre.scrollTop = pre.scrollHeight;
  });

  socket.on('init', data => {
    const pre = document.getElementById('logs');
    pre.textContent = data;
    pre.scrollTop = pre.scrollHeight;
  });

  socket.on('bots', refreshBots);
  window.addEventListener('load', refreshBots);
  </script>
</body>
</html>